<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>GPXmagic</title>
  <script type="text/javascript" src="main.js"></script>
  <script type="text/javascript" src="js/elm-mapbox.umd.js"></script>
  <script type="text/javascript" src="js/PolyFill.js"></script>
</head>

<body>
<div id="myapp"></div>

<script type="text/javascript">

elmMapbox.registerCustomElement(
  {
    token: 'pk.eyJ1IjoicGV0ZXJqYW1lc3dhcmQiLCJhIjoiY2tpdWswb3dsMm02bDMzcDMyNGw1bmh5aSJ9.Fk3ibin0PpeEGXlGsctP1g'
  }
);

const app = Elm.Main.init(
  {
    node: document.getElementById("myapp"),
    flags: rememberedBytes()
  }
);

elmMapbox.registerPorts(app);

// OAuth integration ...
/* Fetch back generated bytes from the local storage */
function rememberedBytes() {
    const bytes = localStorage.getItem("bytes");
    return bytes ? bytes.split(",").map(x => parseInt(x,10)) : null;
}

/* Generate high entropy random bytes using the Web Crypto API and
remember them so that they are preserved between redirections. This
allows to protect for XSS & authorization code attacks */
app.ports.genRandomBytes.subscribe(n => {
    const buffer = new Uint8Array(n);
    crypto.getRandomValues(buffer);
    const bytes = Array.from(buffer);
    localStorage.setItem("bytes", bytes);
    app.ports.randomBytes.send(bytes);
});

</script>

</body>
</html>