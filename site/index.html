<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>GPXmagic</title>
  <script type="text/javascript" src="main.js"></script>
  <script type="text/javascript" src="js/elm-mapbox.umd.js"></script>
  <script type="text/javascript" src="js/PolyFill.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
</head>

<body>
<div id="myapp"></div>

<script type="text/javascript">

elmMapbox.registerCustomElement(
  {  }
);

const app = Elm.Main.init(
  {
    node: document.getElementById("myapp"),
    flags: rememberedBytes()
  }
);

elmMapbox.registerPorts(app);

// OAuth integration ...
/* Fetch back generated bytes from the local storage */
function rememberedBytes() {
    const bytes = localStorage.getItem("bytes");
    return bytes ? bytes.split(",").map(x => parseInt(x,10)) : null;
}

/* Generate high entropy random bytes using the Web Crypto API and
remember them so that they are preserved between redirections. This
allows to protect for XSS & authorization code attacks */
app.ports.genRandomBytes.subscribe(n => {
    const buffer = new Uint8Array(n);
    crypto.getRandomValues(buffer);
    const bytes = Array.from(buffer);
    localStorage.setItem("bytes", bytes);
    app.ports.randomBytes.send(bytes);
});

// Elm uses local storage via this port.
app.ports.commandPort.subscribe(incomingMessageHandler);

function incomingMessageHandler(msg) {
    switch (msg.Cmd) {
        case 'storage.set':
            //console.log(msg.key); console.log(msg.value);
            localStorage.setItem(msg.key, JSON.stringify( msg.value ) );
            break;

        case 'storage.get':
            var val = null;
            try {
              val = JSON.parse(localStorage.getItem(msg.key))
            } catch (e) {
            };
            app.ports.messageReceiver.send({ 'msg' : 'storage.got', 'key' : msg.key, 'value' : val });
            break;

        case 'storage.list':
            var keys = [];
            var cnt = localStorage.length;
            for (var i = 0; i < cnt; i++) {
                var key = localStorage.key(i);
                keys.push(key);
            };
            //console.log(keys);
            app.ports.messageReceiver.send({ 'msg' : 'storage.keys', 'keys' : keys });
            break;

        case 'storage.clear':
            localStorage.clear();
            break;
    }
};


</script>

</body>
</html>